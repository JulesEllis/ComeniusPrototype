#    This project contains CASWIC: Coaching App for Statistical Writing in Introductory Course.
#    Copyright (C) 2023 Jules Ellis and Jelmer Jansen
#
#    This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License along with this program. If not, see https://www.gnu.org/licenses/.
#

#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Fri Dec  9 17:16:58 2022

@author: jelmer
"""
from datetime import datetime, timedelta

class EncryptedCodeSaver:
    def __init__(self):
        self.key = "simpelesleutelvoortestenvanpythoncode349ms49"
        self.offset = 44
    
    def dec2hex(self,dec) -> str:
        hexstr: str = hex(dec)
        returnstr:str = hexstr[2:len(hexstr)]
        if len(returnstr)<2:
            returnstr = "0"+returnstr
        return returnstr

    def encrypt(self,encdata) -> str:
        dataarr = bytes(encdata, 'utf-8')
        keyarr = bytes(self.key, 'utf-8')
        returnstr = self.dec2hex(self.offset)
        keylen = len(self.key)
        for i in range(len(encdata)):
            keypos = (i + self.offset) % keylen
            newchar = (dataarr[i])^(keyarr[keypos])
            returnstr = returnstr + self.dec2hex(newchar)
        return returnstr
    
    def decrypt(self,encdata) -> str:
        #dataarr = bytes(encdata[2::], 'utf-8')
        keyarr = bytes(self.key, 'utf-8')
        encoffset = int("0x"+encdata[0:2],16)
        keylen = len(self.key)
        returnstr = []
        for i in range(len(encdata)):
            datahex=encdata[2+2*i:2+2*i+2]
            databyte=int("0x"+datahex,16)
            keypos = (i + encoffset) % keylen
            newchar = databyte^(keyarr[keypos])
            returnstr.append(newchar)
        return str(bytes(returnstr), 'utf-8')
    
    def encrypt_and_save(self,analysis_type:int, n_mistakes:int, n_attempts:int):
        analysis_name_dict = {1:'TTEST_BETWEEN',
                            2:' TTEST_WITHIN', 
                            3:'ONEWAY_ANOVA',
                            4:'TWOWAY_ANOVA',
                            5:'WITHIN_ANOVA', 
                            6:'MREGRESSION', 
                            11:'MANOVA',
                            12:'ANCOVA',
                            13:'MULTIRM',
                            14:'MULTIRM2'}
        to_encrypt = ';'.join([analysis_name_dict[analysis_type],str(n_mistakes),str(n_attempts),str(datetime.now() + timedelta(hours=1))])
        assignment_code = self.encrypt(to_encrypt)
        with open('/var/www/ComeniusPrototype/ComeniusPrototype/app/result_codes','a') as f:
            f.write(assignment_code + '\n')



#data = "2869597;9;8-12-2022;13:23:58"
